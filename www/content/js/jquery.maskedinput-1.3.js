(function(e){var t=(e.browser.msie?"paste":"input")+".mask";var n=window.orientation!=undefined;e.mask={definitions:{9:"[0-9]",a:"[A-Za-z]","*":"[A-Za-z0-9]"},dataName:"rawMaskFn"};e.fn.extend({caret:function(e,t){if(this.length==0)return;if(typeof e=="number"){t=typeof t=="number"?t:e;return this.each(function(){if(this.setSelectionRange){this.setSelectionRange(e,t)}else if(this.createTextRange){var n=this.createTextRange();n.collapse(true);n.moveEnd("character",t);n.moveStart("character",e);n.select()}})}else{if(this[0].setSelectionRange){e=this[0].selectionStart;t=this[0].selectionEnd}else if(document.selection&&document.selection.createRange){var n=document.selection.createRange();e=0-n.duplicate().moveStart("character",-1e5);t=e+n.text.length}return{begin:e,end:t}}},unmask:function(){return this.trigger("unmask")},mask:function(r,i){if(!r&&this.length>0){var s=e(this[0]);return s.data(e.mask.dataName)()}i=e.extend({placeholder:"_",completed:null},i);var o=e.mask.definitions;var u=[];var a=r.length;var f=null;var l=r.length;e.each(r.split(""),function(e,t){if(t=="?"){l--;a=e}else if(o[t]){u.push(new RegExp(o[t]));if(f==null)f=u.length-1}else{u.push(null)}});return this.trigger("unmask").each(function(){function p(e){while(++e<=l&&!u[e]);return e}function d(e){while(--e>=0&&!u[e]);return e}function v(e,t){if(e<0)return;for(var n=e,r=p(t);n<l;n++){if(u[n]){if(r<l&&u[n].test(c[r])){c[n]=c[r];c[r]=i.placeholder}else break;r=p(r)}}w();s.caret(Math.max(f,e))}function m(e){for(var t=e,n=i.placeholder;t<l;t++){if(u[t]){var r=p(t);var s=c[t];c[t]=n;if(r<l&&u[r].test(s))n=s;else break}}}function g(e){var t=e.which;if(t==8||t==46||n&&t==127){var r=s.caret(),i=r.begin,o=r.end;if(o-i==0){i=t!=46?d(i):o=p(i-1);o=t==46?p(o):o}b(i,o);v(i,o-1);return false}else if(t==27){s.val(h);s.caret(0,E());return false}}function y(e){var t=e.which,n=s.caret();if(e.ctrlKey||e.altKey||e.metaKey||t<32){return true}else if(t){if(n.end-n.begin!=0){b(n.begin,n.end);v(n.begin,n.end-1)}var r=p(n.begin-1);if(r<l){var o=String.fromCharCode(t);if(u[r].test(o)){m(r);c[r]=o;w();var a=p(r);s.caret(a);if(i.completed&&a>=l)i.completed.call(s)}}return false}}function b(e,t){for(var n=e;n<t&&n<l;n++){if(u[n])c[n]=i.placeholder}}function w(){return s.val(c.join("")).val()}function E(e){var t=s.val();var n=-1;for(var r=0,o=0;r<l;r++){if(u[r]){c[r]=i.placeholder;while(o++<t.length){var h=t.charAt(o-1);if(u[r].test(h)){c[r]=h;n=r;break}}if(o>t.length)break}else if(c[r]==t.charAt(o)&&r!=a){o++;n=r}}if(!e&&n+1<a){s.val("");b(0,l)}else if(e||n+1>=a){w();if(!e)s.val(s.val().substring(0,n+1))}return a?r:f}var s=e(this);var c=e.map(r.split(""),function(e,t){if(e!="?")return o[e]?i.placeholder:e});var h=s.val();s.data(e.mask.dataName,function(){return e.map(c,function(e,t){return u[t]&&e!=i.placeholder?e:null}).join("")});if(!s.attr("readonly"))s.one("unmask",function(){s.unbind(".mask").removeData(e.mask.dataName)}).bind("focus.mask",function(){h=s.val();var t=E();w();var n=function(){if(t==r.length)s.caret(0,t);else s.caret(t)};(e.browser.msie?n:function(){setTimeout(n,0)})()}).bind("blur.mask",function(){E();if(s.val()!=h)s.change()}).bind("keydown.mask",g).bind("keypress.mask",y).bind(t,function(){setTimeout(function(){s.caret(E(true))},0)});E()})}})})(jQuery)